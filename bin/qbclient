#!/bin/bash

export BASH_ENV=$(dirname "$0")"/../lib/qbclient/qbfunctions"

#Usage: qbclient ([-k | -c CERTFILE]) [-l USERNAME] [-p PASSWORD] URL <bash options>
{ [ "$1" == "-h" ] || [ "$1" == "--help" ]; } && shift
if [ "$1" == "-k" ]
    then
     QBarg1="-k"
     QBarg2=""
     shift
    else
     if [ "$1" == "-c" ]
        then
         QBarg1="--cacert"
         QBarg2="$2"
         shift
         shift
        else
         QBarg1=""
         QBarg2=""
     fi
fi
if [ "$1" == "-l" ]
    then
     QBlogin="$2"
     shift
     shift
    else
     QBlogin="admin"
fi
if [ "$1" == "-p" ]
    then
     QBpassword="$2"
     shift
     shift
    else
     QBpassword=""
fi
if [ -z "$1" ]
    then
     >&2 echo 'Usage: qbclient [(-k | -c CERTFILE)] [-l USERNAME] [-p PASSWORD] URL [BASH_OPT1] [BASH_OPT2] ...'
     exit 127
fi
if [ -z "$QBpassword" ]
    then
     read -rs -p "Password for $login: " QBpassword
     echo
fi
QBpassword=$(echo "$QBpassword" | jq  -rR @uri)
export QBpassword=$(echo "$RANDOM $QBpassword"|base64|gzip|base64)
export QBlogin=$(echo "$QBlogin" | jq  -rR @uri)
QBurl="$1"
shift
#echo curl $QBarg1 $QBarg2 -i --header "Referer: $1" --data "username=$login&password=$password" "$1/api/v2/auth/login"
QBarg=()
[ -z "$QBarg1" ] || QBarg=("$QBarg1")
[ -z "$QBarg2" ] || QBarg+=("$QBarg2")
export QBarg1
export QBarg2
export QBurl
/bin/bash "$@" --rcfile "$BASH_ENV" "$@"
exitcode="$?"
(curl "${QBarg[@]}" -s --cookie $QBcookie "${QBurl}/api/v2/auth/logout" &>/dev/null) &
exit "$exitcode"
