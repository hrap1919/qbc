#!/bin/bash
#Usage: qbclient ([-k | -c CERTFILE]) [-p PASSWORD] URL LOGIN <bash options>
if [ "$1" == "-k" ]
then
QBarg1="-k"
QBarg2=""
shift
else
if [ "$1" == "-c" ]
then
QBarg1="--cacert"
QBarg2="$2"
shift
shift
else
QBarg1=""
QBarg2=""
fi
fi
export QBarg1
export QBarg2
if [ "$1" == "-p" ]
    then
     if [ $# -lt 4 ]
        then
         echo 'Usage: qbclient [(-k | -c CERTFILE)] [-p PASSWORD] URL LOGIN [BASH_OPT1] [BASH_OPT2] ...'
         exit 127
     fi
     password="$2"
     shift
     shift
    else
     if [ $# -lt 2 ]
        then
         echo 'Usage: qbclient [(-k | -c CERTFILE)] [-p PASSWORD] URL LOGIN [BASH_OPT1] [BASH_OPT2] ...'
         exit 127
     fi
     read -rs -p "Password: " password
     echo
fi
password=$(echo "$password" | jq  -rR @uri)
login=$(echo "$2" | jq  -rR @uri)
#echo curl $QBarg1 $QBarg2 -i --header "Referer: $1" --data "username=$login&password=$password" "$1/api/v2/auth/login"
IFS=";"; read exitcode QBcookie <<<$(exitcode="";curl $QBarg1 $QBarg2 -i --header "Referer: $1" --data "username=$login&password=$password" "$1/api/v2/auth/login" 2>/dev/null |
(IFS=" "; while read line1 line2 line3; do [ -z $exitcode ] && { exitcode=$line2; printf "$line2;"; }; [ $line1 == "set-cookie:" ] && printf $line2; done))
#$(curl $QBarg1 $QBarg2 -c - --header "Referer: $1" --data "username=$login&password=$password" "$1/api/v2/auth/login" 2>/dev/null | cut -sf7)
if [ -z "$QBcookie" ]
then
if [ "$exitcode" == 200 ]
then echo "Fail. Invalid username/password"
else
if [ "$exitcode" == 403 ]
then echo "Fail. Your IP is banned"
else echo "Fail. May be this is a connection problem"
fi
fi
#echo Fail, Exit Code: $exitcode
else
function exit ()
{
if [ ! -z "$QBurl" ]
then
curl $QBarg1 $QBarg2 -s --cookie $QBcookie "${QBurl}/api/v2/auth/logout" &>/dev/null
echo Logged out
fi
builtin exit "$@"
}
. $(dirname "$0")"/../lib/qbclient/qbfunctions"
declare -fx exit
declare -fx qblogin
declare -fx qblogout
declare -fx qbaddurl
declare -fx qbaddfile
declare -fx qbaddpaused
declare -fx qbprefget
declare -fx qbprefset
declare -fx qbpasswd
declare -fx qbinfo
declare -fx qbselect
declare -fx qbdel
declare -fx qbtorinfo
declare -fx qbtorprop
declare -fx qbtrackers
declare -fx qbcommand
declare -fx qbmedia
declare -fx qbsetlocation
declare -fx qbpeers
declare -fx qbcontent
declare -fx qbfileinfo
declare -fx qbfileprio

export QBcookie
#="SID=$QBcookie"
export QBurl="$1"
shift
shift
HISTFILE="$HOME/.qbclient_history" PROMPT_COMMAND='PS1=\$QBurl"/"\${QBhash:0:5}"> ";unset PROMPT_COMMAND' /bin/bash "$@"
curl $QBarg1 $QBarg2 -s --cookie $QBcookie "${QBurl}/api/v2/auth/logout" &> /dev/null
fi
