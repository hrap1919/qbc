#!/bin/bash

export BASH_ENV=$(dirname "$0")"/../lib/qbclient/qbfunctions"

#Usage: qbclient ([-k | -c CERTFILE]) [-l USERNAME] [-p PASSWORD] URL <bash options>
{ [ "$1" == "-h" ] || [ "$1" == "--help" ]; } && shift
if [ "$1" == "-k" ]
    then
     QB_arg1="-k"
     QB_arg2=""
     shift
    else
     if [ "$1" == "-c" ]
        then
         QB_arg1="--cacert"
         QB_arg2="$2"
         shift
         shift
        else
         QB_arg1=""
         QB_arg2=""
     fi
fi
export QB_arg1
export QB_arg2
if [ "$1" == "-l" ]
    then
     QB_login="$2"
     shift
     shift
    else
     QB_login="admin"
fi
export QB_login=$(echo "$QB_login" | jq  -rR @uri)
if [ "$1" == "-p" ]
    then
     QB_password="$2"
     shift
     shift
    else
     QB_password=""
fi
if [ -z "$1" ]
    then
     >&2 echo 'Usage: qbclient [(-k | -c CERTFILE)] [-l USERNAME] [-p PASSWORD] URL [BASH_OPT1] [BASH_OPT2] ...'
     exit 127
fi
if [ -z "$QB_password" ]
    then
     read -rs -p "Password for $QB_login: " QB_password
     echo
fi
export QB_password=$(echo "$QB_password" | jq  -rR @uri)
export QB_url="$1"
shift
/bin/bash "$@" --rcfile "$BASH_ENV" "$@"
exitcode="$?"
exit "$exitcode"
